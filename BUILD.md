# Building frkr-operator

## Prerequisites

- Go 1.21+ (required for Kubernetes client libraries)
- controller-gen tool (for code generation)

## Installation

### Install controller-gen

```bash
go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest

# Add to PATH
export PATH=$PATH:$(go env GOPATH)/bin

# Verify
controller-gen --version
```

**Permanent Setup**: Add to `~/.bashrc` or `~/.zshrc`:
```bash
export PATH=$PATH:$(go env GOPATH)/bin
```

## Build Steps

### Step 1: Generate DeepCopy Methods

**CRITICAL**: This must be done before building. The operator CRDs require generated DeepCopy methods.

```bash
cd frkr-operator

# Generate code
controller-gen object:headerFile=".tools/boilerplate.go.txt" paths="./api/..."

# Or use Makefile
make generate
```

This creates `api/v1/zz_generated.deepcopy.go` with DeepCopy methods for all CRD types.

### Step 2: Verify Generated File

Check that `api/v1/zz_generated.deepcopy.go` exists and starts with:

```go
//go:build !ignore_autogenerated
// +build !ignore_autogenerated

// Code generated by controller-gen. DO NOT EDIT.

package v1
```

**Known Issue**: If the generated file has wrong package name or duplicate declarations:
1. Check the file starts with correct build tags
2. Ensure only one `package v1` declaration
3. Regenerate if needed

### Step 3: Build

```bash
go build ./cmd/operator/...

# Or use Makefile
make build
```

### Step 4: Run Tests

```bash
go test ./...

# Or use Makefile
make test
```

## Using Makefile

The repository includes a Makefile with common tasks:

```bash
# Generate code (DeepCopy methods)
make generate

# Build binary
make build

# Run tests
make test

# Format code
make fmt

# Run linter
make vet

# All of the above
make all
```

## Troubleshooting

### Error: "controller-gen: command not found"

**Solution**: Install controller-gen and add to PATH (see Installation above).

### Error: "found packages v1 and hack"

**Solution**: The generated file has wrong package name. Check `api/v1/zz_generated.deepcopy.go`:
- Should have `package v1` (not `package hack`)
- Should have correct build tags
- Regenerate if needed

### Error: "package cmp is not in GOROOT"

**Solution**: Go 1.21+ required. Upgrade Go version.

### Error: "unknown field MetricsBindAddress"

**Solution**: This is a controller-runtime API change. The code has been updated to use the new API. If you see this error, ensure you have the latest code.

## CI/CD

For CI systems, ensure:

1. Go 1.21+ is installed
2. controller-gen is installed:
   ```yaml
   - run: go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest
   - run: export PATH=$PATH:$(go env GOPATH)/bin
   ```
3. Code is generated before build:
   ```yaml
   - run: make generate
   ```
4. Build and test:
   ```yaml
   - run: make build
   - run: make test
   ```

## Dependencies

- `github.com/frkr-io/frkr-common v0.1.0` - Shared library (migrations, utilities)
- `sigs.k8s.io/controller-runtime` - Kubernetes operator framework
- `k8s.io/apimachinery` - Kubernetes API machinery
- `k8s.io/client-go` - Kubernetes client

All dependencies are managed via `go.mod`.

**Note**: For local development, you can use a `replace` directive in `go.mod`:
```go
replace github.com/frkr-io/frkr-common => ../frkr-common
```

